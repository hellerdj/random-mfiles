function [p,llik, df, ph1] = anova_nh(x,h1)% [p,llik, df, ph1] = anova_nh(x,h1)%	Performs anova as a nested hypothesis test. %	Each row of x is an observation.  The last column of x is the%	dependent variable.  Each column before that represents a%	categorical variable.  The routine tests for significance of each of%	the categories, plus one interaction specified as a combination of%	categories.   Think of the test as asking the question, "does it%	help to know that the dependent variable was associated with the%	categories specified in column 1?"  The answer to this question is%	p(1).  The answer for each of the columns is p(i).  The function%	returns p and the log likelihood of obtaining the data under the%	model associated with each column (llik) and the degrees of freedom%	associated with each of these models.   For example, if category 1%	has 4 unique values, then there are 4 means and 4 stdevs, or 8 df.%	Optionally, a second argument, h1, specifies a more complicated%	model that a combination of categories might matter.  For example,%	if h1 = [1 2], one is testing for an interaction between the%	categorical variables in column 1 and column 2, i.e., this is the%	hypothesis that "it matters to know both the value in column 1 and%	2."  This hypothesis is compared to the null hypothesis (which is%	basically useless) and is returned as the last element of p (with%	corresponding elements in llik and df).  It is also compared to the%	simple category models, and returned as a vector of p values, ph1,%	one pval for each of the categories.%%	Note: %	The number of categories within each categorical variable can be any%	number >= 2.  There should be at least 3 observations for each%	unique value of the categorical variable, and at least 3 for any%	combination of categorical variables that will be analyzed for%	interaction.  %%                                                    M N Shadlen, April 17, 1995% fake data for testing%$$$ N = 200;%$$$ a = round(rand(N,3)*2);%$$$ h1 = [1 2]%$$$ % only the 1st column should matter%$$$ x = [a randn(size(a,1),1) + a(:,1)];%$$$ % 1,2 and interaction should matter%$$$ x = [a randn(size(a,1),1) + a(:,1) + a(:,2)];%$$$ corrcoef(x)%$$$ % no effect%$$$ x = [a randn(size(a,1),1) + randn(size(a,1),1)];%$$$ error('You forgot to comment out the test lines')% useful constantsnc = size(x,2)-1;			% number of categoriesI = size(x,2);			% index for the dependent variable% compute ll under h0y = x(:,I);				% all the dependent vars, lumpedm0 = mean(y);s0 = std(y);ll0 = sum(-0.5*(((y-m0)/s0).^2) - log(sqrt(2*pi)*s0));%% compute ll for each categorydf = nan * ones(1,nc); p = df; llik = df; % initialize the arraysfor i = 1:nc  % how many unique values are there in this category  a = munique(x(:,i));  df(i) = 2 * length(a);			% degrees of freedom  m = nan * ones(size(a));   s = m;  for j = 1:length(a)    ival = a(j);			% the independent value    L = x(:,i)==ival;			% select matches    n = sum(L);				% how many?    if sum(L) < 2      error('anova_nh: too few observations');    end    y = x(L,I);				% collect the dependent vars    m(j) = mean(y);			% mean    s(j) = std(y);			% stdev    sumll(j) = sum(-0.5*(((y-m(j))/s(j)).^2) - log(sqrt(2*pi)*s(j)));  end  % add the llik for each of the values in this category  llik(i) = sum(sumll);  p(i) =  1 - chi2cdf(2*(llik(i)-ll0), (df(i)-2));end%% now for the specific hypothesis, h1if nargin > 1  i = nc + 1;  a = munique(x(:,h1)); 	% unique row vectors in cols specified by h1  df(i) = 2 * size(a,1); 		% degrees of freedom  m = nan * ones(size(a,1),1);		% initialize  s = m;  for j = 1:size(a,1)    ival = a(j,:);			% the independent value vector    % next line uses the ones trick to repeat ival on every line    % the logic returns 0 or 1 as a row vector for each obs.    % we take the row products by taking the prod of transpose and then    % transpose back.  L is then a standard selection array.    L = prod((x(:,h1)==ival(ones(size(x,1),1),:))')';    n = sum(L);    if sum(L) < 2      error('anova_nh: too few observations in h1');    end    y = x(L,I);    m(j) = mean(y);    s(j) = std(y);    sumll(j) = sum(-(y-m(j)).^2/(2*s(j)*s(j)) - log(sqrt(2*pi)*s(j)));    % sumll(j) = sum(log(normpdf(y,m(j),s(j))));  end  % add the llik for each of the values in this category  llik(i) = sum(sumll);  p(i) =  1 - chi2cdf(2*(llik(i)-ll0),df(i)-2);end% compare h1 against each of the simple categoriesfor j = 1:nc  ph1(j) = 1 - chi2cdf(2*(llik(nc+1)-llik(j)), df(nc+1)-df(j));end 