function [p,p1NotSmaller,p1NotBigger,orat,E] = fisherExact(a,b,c,d)% [p,p1NotSmaller,p1NotBigger,orat,E] = fisherExact(a,b,c,d)% Computes Fisher's exact test on 2-by-2 contingency table% The return vals are % p   the probability of obtaining this table or one more extreme if %     the odds ratio were = 1; H0:p1=p2, H1:p1~=p2% p1NotSmaller is a one-sided version of the test in which H0:p1=p2 is compared to H1:p1<p2% p1NotBigger is a one-sided version of the test in which H0:p1=p2 is compared to H1:p1>p2% For convenience, the routine returns the odds ratio (orat) and% a 2-by-2 matrix, E, containing the expected table.% requires stats Toolbox.% See also oddsratio.m% test vals% a = 2, b=23, c=5, d=30, alpha = 0.05% error('forgot to comment out test data')%% marginalsn1 = a+b;   % row 1 n2 = c+d;   % row 2m1 = a+c;   % col 1m2 = b+d;   % col 2n = a+b+c+d;  % totalE = [n1*m1 n1*m2; n2*m1 n2*m2] / n;if (all(floor(E(:)) > 5))  warning('Fisher''s Exact Test should not be used unless at least one cell has an expected value less than 5')end% enumerate all possible tables% arrange the table so that the smaller row total is in the 1st rowif n2<n1  q = [b c;a b];  a = q(1,1); b = q(1,2); c = q(2,1); d = q(2,2);endT = [a b; c d];% i = 5% Tn = repmat(0,[2 2 m1+1]);avect = [0:m1]';pT = hygepdf(avect,n,m1,n1);p = 2 * min([sum(pT(avect<=T(1,1))), sum(pT(avect>=T(1,1))), 0.5]);p1NotSmaller = sum(pT(avect<=T(1,1)));p2NotBigger = sum(pT(avect>=T(1,1)));% This whole loop can be skipped.  We can compute the probabilities from% the hypergeometric distribution directly.% for i = 0:m1%   a = i;%   c = m1-a;%   b = n1-a;%   d = n2-c;%   Tn(:,:,i+1) = [a b; c d];% %   % The following expression computes the probability of obtaining %   % the table given the marginals.  It is an exact probability.%   % I replace this one expression with the stats toolbox call below.%   % It is the probability of getting table with cell(1,1) = a, given the %   % marginals.%   %%   %   (factorial(a+b)/factorial(a)) * ...%   %   (factorial(c+d)/factorial(b)) * ...%   %   (factorial(a+c)/factorial(c)) * ...%   %   (factorial(b+d)/factorial(d)) / factorial(n)%   pT(i+1) = hygepdf(a,(a+b+c+d),(a+c),(a+b))% end  