function [pMH,pHOM, chi2MH, chi2HOM,odds,oddsMH] = mantelHaenszel(x)% [pMH,pHOM, chi2MH, chi2HOM,odds,oddsMH] = mantelHaenszel(x)% Computes Mantel-Haenszel statistic% for data in contingency table, x.  X is an n by m by k table of% counts. The last dimension, k, is the number of strata. % The MH statistic can be thought of as a Chi2 test on the table within% the strata.  I've tested it with 2 by 2 by k only. % If size(x) is 2 by 2 by k, then the routine also calculates the odds% ratios within each of the k strata and tests the 'Homogeneity of the% Odds Ratio.'  The pvalue for the latter test is returned as pHOM, the% chi2 value is returned as chi2HOM.  The odds ratios for each strata are % returned as odds and the Odds Ratio combined across the strata is% returned as oddsMH. % pHOM is the probability of obtaining such variety of odds ratios as% seen across the strata under the null hypothesis that strata does not% matter. % %% From Rosner, Section 10.10, p.407% 6/11/99 mns wrote itk = size(x,3);				% number of strataObs = sum(x(1,1,:));Ei = zeros(k,1);Ni = zeros(k,1);for i = 1:k  Ni(i) = sum(sum(squeeze(x(:,:,i))));  Ei(i) = (x(1,1,i) + x(1,2,i)) .* (x(1,1,i) + x(2,1,i)) / Ni(i);endE = sum(Ei);% varianceVi = zeros(k,1);for i = 1:k  Vi(i) = (x(1,1,i) + x(1,2,i)) .* (x(2,1,i) + x(2,2,i)) .* ...	  (x(1,1,i) + x(2,1,i)) .* (x(1,2,i) + x(2,2,i)) / ...	  (Ni(i).^2 .* (Ni(i)-1));endV = sum(Vi);if V < 5  warning('Mantel-Haenszel test is invalid for data')  chi2MH = nan;  pMH = nan;else   chi2MH = (abs(Obs - E) - 0.5).^2 / V;  pMH = 1 - chi2cdf(chi2MH,1);endif size(x,1)==2 & size(x,2)==2  % Within strata there are dichotomous 'disease' and 'exposure'  % variables.  So we can compute odds ratios and determine if there is an   % effect of strata, i.e., test for Homogeneity of the Odds Ratio  wi = zeros(k,1); odds = zeros(k,1); term1 = zeros(k,1); term2=zeros(k,1);  for i = 1:k    wi(i) = 1./(sum(1./(reshape(x(:,:,i),4,1))));    odds(i) = x(1,1,i)*x(2,2,i) / (x(1,2,i)*x(2,1,i));    term1(i) = wi(i) * (log(odds(i)).^2);    % term 2 does not have the square yet    term2(i) = wi(i) * log(odds(i));  end  % Mantel-Haenszel combined odds (Rosner eq. 10.40)  oddsMH = sum(squeeze(x(1,1,:).*x(2,2,:)) ./ Ni) ./ ...	   sum(squeeze(x(1,2,:).*x(2,1,:)) ./  Ni);  chi2HOM = sum(term1) - (sum(term2).^2)/sum(wi);  pHOM = 1 - chi2cdf(chi2HOM,k-1);end